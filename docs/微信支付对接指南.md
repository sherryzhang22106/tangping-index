# 微信支付对接经验总结

## 一、支付方式选择

| 支付方式 | 适用场景 | 需要的权限 | 用户体验 |
|---------|---------|-----------|---------|
| **JSAPI支付** | 微信内H5页面 | 需要微信公众号 | 最佳，直接唤起支付 |
| **Native支付** | PC网页 | 基础权限即可 | 扫码支付 |
| **H5支付** | 手机浏览器（非微信） | 需要单独申请 | 跳转微信APP支付 |

⚠️ **重要**：H5支付需要在微信商户平台单独申请开通，不是默认就有的！

---

## 二、实现方案

### 1. PC端 - Native支付（二维码）

```typescript
// 生成支付二维码
const result = await fetch('/api/payment?action=create', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    visitorId,
    amount: price,
    description: '商品描述'
  }),
});
const data = await result.json();

// data.codeUrl 就是二维码内容，用第三方API生成图片
const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(data.codeUrl)}`;
```

### 2. 微信内 - JSAPI支付

```typescript
// 步骤1: 获取微信授权code
const oauthUrl = `https://open.weixin.qq.com/connect/oauth2/authorize?appid=${APPID}&redirect_uri=${encodeURIComponent(redirectUrl)}&response_type=code&scope=snsapi_base#wechat_redirect`;
window.location.href = oauthUrl;

// 步骤2: 用户授权后，页面会带上code参数，用code换取openid，创建订单，获取支付参数
const urlParams = new URLSearchParams(window.location.search);
const wxCode = urlParams.get('code');

const result = await fetch('/api/payment?action=jsapi', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ visitorId, code: wxCode, amount, description }),
});
const data = await result.json();

// 步骤3: 调起微信支付
WeixinJSBridge.invoke('getBrandWCPayRequest', {
  appId: data.appId,
  timeStamp: data.timeStamp,
  nonceStr: data.nonceStr,
  package: data.package,
  signType: data.signType,
  paySign: data.paySign,
}, (res) => {
  if (res.err_msg === 'get_brand_wcpay_request:ok') {
    // 支付成功
    onPaymentSuccess();
  } else if (res.err_msg === 'get_brand_wcpay_request:cancel') {
    // 用户取消
  } else {
    // 支付失败
  }
});
```

### 3. 手机浏览器（无H5权限）- 降级方案

```typescript
// 如果没有H5支付权限，只能显示二维码让用户用微信扫码
if (isMobile && !isWechat) {
  // 显示二维码，提示用户用微信扫码
  await generateQRCode();
}
```

---

## 三、后端API结构（Vercel Serverless）

```typescript
// api/payment.ts
import type { VercelRequest, VercelResponse } from '@vercel/node';

export default async function handler(req: VercelRequest, res: VercelResponse) {
  const { action } = req.query;

  switch (action) {
    case 'create':
      // Native支付 - 生成二维码
      return handleNativePayment(req, res);

    case 'jsapi':
      // JSAPI支付 - 微信内支付
      return handleJSAPIPayment(req, res);

    case 'oauth':
      // 获取微信授权URL
      return handleOAuth(req, res);

    case 'query':
      // 查询支付状态
      return handleQuery(req, res);

    case 'notify':
      // 支付回调通知
      return handleNotify(req, res);

    default:
      return res.status(400).json({ error: '未知操作' });
  }
}
```

---

## 四、关键配置

### 环境变量（.env 或 Vercel Environment Variables）

```env
# 微信公众号
WECHAT_APPID=wx...              # 公众号AppID
WECHAT_APP_SECRET=...           # 公众号密钥（JSAPI需要，用于获取openid）

# 微信商户号
WECHAT_MCHID=16...              # 商户号
WECHAT_API_KEY=...              # APIv3密钥（32位）
WECHAT_SERIAL_NO=...            # 证书序列号
WECHAT_PRIVATE_KEY=...          # 私钥（需要转义换行符为\n）

# 回调地址
PAYMENT_NOTIFY_URL=https://yourdomain.com/api/payment?action=notify
```

### 私钥格式注意

私钥需要包含完整的头尾，换行符用 `\n` 表示：

```
-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBg...\n...\n-----END PRIVATE KEY-----
```

### 微信商户平台配置

1. **产品中心 → 开发配置**
   - 支付授权目录：`https://yourdomain.com/`（JSAPI需要，注意末尾斜杠）
   - Native支付回调URL：`https://yourdomain.com/api/payment?action=notify`

2. **账户中心 → API安全**
   - 设置APIv3密钥
   - 申请API证书，获取证书序列号和私钥

### 微信公众平台配置（JSAPI需要）

1. **设置与开发 → 公众号设置 → 功能设置**
   - 网页授权域名：`yourdomain.com`（不带协议和路径）
   - JS接口安全域名：`yourdomain.com`

2. **设置与开发 → 基本配置**
   - 获取 AppID 和 AppSecret

---

## 五、签名生成（APIv3）

```typescript
import crypto from 'crypto';

// 生成随机字符串
function generateNonceStr(): string {
  return crypto.randomBytes(16).toString('hex');
}

// 生成签名
function generateSignature(
  method: string,
  url: string,
  timestamp: string,
  nonceStr: string,
  body: string,
  privateKey: string
): string {
  const message = `${method}\n${url}\n${timestamp}\n${nonceStr}\n${body}\n`;
  const sign = crypto.createSign('RSA-SHA256');
  sign.update(message);
  return sign.sign(privateKey, 'base64');
}

// 构建 Authorization header
function buildAuthHeader(
  method: string,
  url: string,
  body: string,
  mchid: string,
  serialNo: string,
  privateKey: string
): string {
  const timestamp = Math.floor(Date.now() / 1000).toString();
  const nonceStr = generateNonceStr();
  const signature = generateSignature(method, url, timestamp, nonceStr, body, privateKey);

  return `WECHATPAY2-SHA256-RSA2048 mchid="${mchid}",nonce_str="${nonceStr}",signature="${signature}",timestamp="${timestamp}",serial_no="${serialNo}"`;
}

// 使用示例
const authorization = buildAuthHeader(
  'POST',
  '/v3/pay/transactions/native',
  JSON.stringify(requestBody),
  MCHID,
  SERIAL_NO,
  PRIVATE_KEY
);

const response = await fetch('https://api.mch.weixin.qq.com/v3/pay/transactions/native', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': authorization,
  },
  body: JSON.stringify(requestBody),
});
```

---

## 六、JSAPI支付签名（前端调起支付用）

```typescript
// JSAPI支付需要单独的签名，用于前端调起支付
function generateJSAPISign(
  appId: string,
  timeStamp: string,
  nonceStr: string,
  packageStr: string,
  privateKey: string
): string {
  const message = `${appId}\n${timeStamp}\n${nonceStr}\n${packageStr}\n`;
  const sign = crypto.createSign('RSA-SHA256');
  sign.update(message);
  return sign.sign(privateKey, 'base64');
}

// 返回给前端的数据
const jsapiParams = {
  appId: APPID,
  timeStamp: Math.floor(Date.now() / 1000).toString(),
  nonceStr: generateNonceStr(),
  package: `prepay_id=${prepayId}`,
  signType: 'RSA',
  paySign: generateJSAPISign(APPID, timeStamp, nonceStr, `prepay_id=${prepayId}`, PRIVATE_KEY),
};
```

---

## 七、获取 OpenID（JSAPI支付必需）

```typescript
// 用授权code换取access_token和openid
async function getOpenId(code: string): Promise<string> {
  const url = `https://api.weixin.qq.com/sns/oauth2/access_token?appid=${APPID}&secret=${APP_SECRET}&code=${code}&grant_type=authorization_code`;

  const response = await fetch(url);
  const data = await response.json();

  if (data.errcode) {
    throw new Error(`获取openid失败: ${data.errmsg}`);
  }

  return data.openid;
}
```

---

## 八、支付回调处理

```typescript
async function handleNotify(req: VercelRequest, res: VercelResponse) {
  try {
    // 1. 验证签名（重要！防止伪造回调）
    // 2. 解密回调数据
    // 3. 更新订单状态
    // 4. 返回成功响应

    return res.status(200).json({
      code: 'SUCCESS',
      message: '成功'
    });
  } catch (error) {
    return res.status(500).json({
      code: 'FAIL',
      message: '处理失败'
    });
  }
}
```

---

## 九、前端判断环境

```typescript
// 判断是否在微信内
const isWechat = /micromessenger/i.test(navigator.userAgent);

// 判断是否是移动端
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

// 支付逻辑
function handlePayment() {
  if (isWechat) {
    // 微信内 -> JSAPI支付
    startJSAPIPayment();
  } else if (isMobile) {
    // 手机浏览器 -> H5支付（需权限）或显示二维码
    if (hasH5Permission) {
      startH5Payment();
    } else {
      showQRCode(); // 降级方案
    }
  } else {
    // PC -> Native支付（二维码）
    showQRCode();
  }
}
```

---

## 十、支付流程图

```
用户点击支付
    │
    ├─ 微信内？
    │   │
    │   └─ 是 ──→ 检查URL是否有code参数
    │              │
    │              ├─ 无code ──→ 跳转微信授权页面
    │              │
    │              └─ 有code ──→ 获取openid → 创建订单 → JSAPI支付
    │
    └─ 否
        │
        ├─ 手机浏览器？
        │   │
        │   ├─ 有H5权限 ──→ H5支付（跳转微信APP）
        │   │
        │   └─ 无H5权限 ──→ 显示二维码（提示用微信扫码）
        │
        └─ PC ──→ 生成Native支付二维码
                    │
                    └─ 用户扫码支付 → 轮询查询支付状态 → 支付成功
```

---

## 十一、常见问题排查

### 1. 签名错误 (SIGN_ERROR)

- ✅ 检查私钥格式（需要完整的 `-----BEGIN PRIVATE KEY-----` 和 `-----END PRIVATE KEY-----`）
- ✅ 检查换行符（环境变量中用 `\n` 表示实际换行）
- ✅ 检查签名字符串的顺序和换行（每个字段后面都要有 `\n`）
- ✅ 检查证书序列号是否正确

### 2. JSAPI支付失败

- ✅ 确认公众号已关联商户号（商户平台 → 产品中心 → AppID账号管理）
- ✅ 确认支付授权目录配置正确（注意末尾斜杠）
- ✅ 确认获取到了正确的 openid
- ✅ 确认 WeixinJSBridge 已就绪

### 3. 回调收不到

- ✅ 确认回调URL可公网访问（不能是 localhost）
- ✅ 确认返回了正确的响应格式 `{ code: 'SUCCESS', message: '成功' }`
- ✅ 确认没有被防火墙拦截

### 4. 二维码无法支付

- ✅ 确认商户号已开通 Native 支付
- ✅ 确认订单金额正确（单位是分）
- ✅ 确认商户号状态正常

---

## 十二、参考文件

本项目的实现可参考：
- 后端：`api/payment.ts`
- 前端：`src/components/PaymentModal.tsx`

---

## 十三、官方文档

- [微信支付 APIv3 文档](https://pay.weixin.qq.com/wiki/doc/apiv3/apis/index.shtml)
- [Native支付](https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_4_1.shtml)
- [JSAPI支付](https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_1_1.shtml)
- [H5支付](https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_3_1.shtml)
- [微信网页授权](https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html)
